

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->

<!-- Mirrored from solidity.readthedocs.io/en/v0.5.8/solidity-by-example.html by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 01 May 2019 10:26:55 GMT -->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Solidity by Example &mdash; Solidity 0.5.8 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
        <script type="text/javascript" src="https://assets.readthedocs.org/static/javascript/readthedocs-doc-embed.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/custom.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Solidity in Depth" href="solidity-in-depth.html" />
    <link rel="prev" title="Installing the Solidity Compiler" href="installing-solidity.html" /> 

<!-- RTD Extra Head -->

<!-- 
Always link to the latest version, as canonical.
http://docs.readthedocs.org/en/latest/canonical.html
-->
<link rel="canonical" href="https://solidity.readthedocs.io/en/v0.5.7/solidity-by-example.html" />

<link rel="stylesheet" href="https://assets.readthedocs.org/static/css/readthedocs-doc-embed.css" type="text/css" />

<script type="text/javascript" src="_static/readthedocs-data.js"></script>

<!-- Add page-specific data, which must exist in the page js, not global -->
<script type="text/javascript">
READTHEDOCS_DATA['page'] = 'solidity-by-example'
READTHEDOCS_DATA['source_suffix'] = '.rst'
</script>

<script type="text/javascript" src="https://assets.readthedocs.org/static/javascript/readthedocs-analytics.js"></script>

<!-- end RTD <extrahead> -->
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index-2.html" class="icon icon-home"> Solidity
          

          
          </a>

          
            
            
            
              <div class="version">
                v0.5.8
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="https://solidity.readthedocs.io/en/v0.5.8/search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
    
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction-to-smart-contracts.html">Introduction to Smart Contracts</a></li>
<li class="toctree-l1"><a class="reference internal" href="installing-solidity.html">Installing the Solidity Compiler</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Solidity by Example</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#voting">Voting</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#possible-improvements">Possible Improvements</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#blind-auction">Blind Auction</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#simple-open-auction">Simple Open Auction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">Blind Auction</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#safe-remote-purchase">Safe Remote Purchase</a></li>
<li class="toctree-l2"><a class="reference internal" href="#micropayment-channel">Micropayment Channel</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#creating-and-verifying-signatures">Creating and verifying signatures</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#creating-the-signature">Creating the signature</a></li>
<li class="toctree-l4"><a class="reference internal" href="#what-to-sign">What to Sign</a></li>
<li class="toctree-l4"><a class="reference internal" href="#packing-arguments">Packing arguments</a></li>
<li class="toctree-l4"><a class="reference internal" href="#recovering-the-message-signer-in-solidity">Recovering the Message Signer in Solidity</a></li>
<li class="toctree-l4"><a class="reference internal" href="#extracting-the-signature-parameters">Extracting the Signature Parameters</a></li>
<li class="toctree-l4"><a class="reference internal" href="#computing-the-message-hash">Computing the Message Hash</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-full-contract">The full contract</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#writing-a-simple-payment-channel">Writing a Simple Payment Channel</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#what-is-a-payment-channel">What is a Payment Channel?</a></li>
<li class="toctree-l4"><a class="reference internal" href="#opening-the-payment-channel">Opening the Payment Channel</a></li>
<li class="toctree-l4"><a class="reference internal" href="#making-payments">Making Payments</a></li>
<li class="toctree-l4"><a class="reference internal" href="#closing-the-payment-channel">Closing the Payment Channel</a></li>
<li class="toctree-l4"><a class="reference internal" href="#channel-expiration">Channel Expiration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id3">The full contract</a></li>
<li class="toctree-l4"><a class="reference internal" href="#verifying-payments">Verifying Payments</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#modular-contracts">Modular Contracts</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="solidity-in-depth.html">Solidity in Depth</a></li>
<li class="toctree-l1"><a class="reference internal" href="natspec-format.html">NatSpec Format</a></li>
<li class="toctree-l1"><a class="reference internal" href="security-considerations.html">Security Considerations</a></li>
<li class="toctree-l1"><a class="reference internal" href="resources.html">Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="using-the-compiler.html">Using the compiler</a></li>
<li class="toctree-l1"><a class="reference internal" href="metadata.html">Contract Metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="abi-spec.html">Contract ABI Specification</a></li>
<li class="toctree-l1"><a class="reference internal" href="yul.html">Yul</a></li>
<li class="toctree-l1"><a class="reference internal" href="style-guide.html">Style Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="common-patterns.html">Common Patterns</a></li>
<li class="toctree-l1"><a class="reference internal" href="bugs.html">List of Known Bugs</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="lll.html">LLL</a></li>
</ul>

            
          
    <a href="genindex.html">Keyword Index</a>
  
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index-2.html">Solidity</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index-2.html">Docs</a> &raquo;</li>
        
      <li>Solidity by Example</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/ethereum/solidity/blob/v0.5.8/docs/solidity-by-example.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="solidity-by-example">
<h1>Solidity by Example<a class="headerlink" href="#solidity-by-example" title="Permalink to this headline">¶</a></h1>
<div class="section" id="voting">
<span id="index-0"></span><span id="id1"></span><h2>Voting<a class="headerlink" href="#voting" title="Permalink to this headline">¶</a></h2>
<p>The following contract is quite complex, but showcases
a lot of Solidity’s features. It implements a voting
contract. Of course, the main problems of electronic
voting is how to assign voting rights to the correct
persons and how to prevent manipulation. We will not
solve all problems here, but at least we will show
how delegated voting can be done so that vote counting
is <strong>automatic and completely transparent</strong> at the
same time.</p>
<p>The idea is to create one contract per ballot,
providing a short name for each option.
Then the creator of the contract who serves as
chairperson will give the right to vote to each
address individually.</p>
<p>The persons behind the addresses can then choose
to either vote themselves or to delegate their
vote to a person they trust.</p>
<p>At the end of the voting time, <code class="docutils literal notranslate"><span class="pre">winningProposal()</span></code>
will return the proposal with the largest number
of votes.</p>
<div class="highlight-Solidity notranslate"><div class="highlight"><pre><span></span><span class="kr">pragma solidity</span> <span class="o">&gt;=</span><span class="mf">0.4</span><span class="p">.</span><span class="mi">22</span> <span class="o">&lt;</span><span class="mf">0.7</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="c1">/// </span><span class="cs">@title</span><span class="c1"> Voting with delegation.</span>
<span class="kd">contract</span> <span class="n">Ballot</span> <span class="p">{</span>
    <span class="c1">// This declares a new complex type which will</span>
    <span class="c1">// be used for variables later.</span>
    <span class="c1">// It will represent a single voter.</span>
    <span class="kd">struct</span> <span class="n">Voter</span> <span class="p">{</span>
        <span class="kt">uint</span> <span class="n">weight</span><span class="p">;</span> <span class="c1">// weight is accumulated by delegation</span>
        <span class="kt">bool</span> <span class="n">voted</span><span class="p">;</span>  <span class="c1">// if true, that person already voted</span>
        <span class="kt">address</span> <span class="n">delegate</span><span class="p">;</span> <span class="c1">// person delegated to</span>
        <span class="kt">uint</span> <span class="n">vote</span><span class="p">;</span>   <span class="c1">// index of the voted proposal</span>
    <span class="p">}</span>

    <span class="c1">// This is a type for a single proposal.</span>
    <span class="kd">struct</span> <span class="n">Proposal</span> <span class="p">{</span>
        <span class="kt">bytes32</span> <span class="n">name</span><span class="p">;</span>   <span class="c1">// short name (up to 32 bytes)</span>
        <span class="kt">uint</span> <span class="n">voteCount</span><span class="p">;</span> <span class="c1">// number of accumulated votes</span>
    <span class="p">}</span>

    <span class="kt">address</span> <span class="kr">public</span> <span class="n">chairperson</span><span class="p">;</span>

    <span class="c1">// This declares a state variable that</span>
    <span class="c1">// stores a `Voter` struct for each possible address.</span>
    <span class="kd">mapping</span><span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="n">Voter</span><span class="p">)</span> <span class="kr">public</span> <span class="n">voters</span><span class="p">;</span>

    <span class="c1">// A dynamically-sized array of `Proposal` structs.</span>
    <span class="n">Proposal</span><span class="p">[]</span> <span class="kr">public</span> <span class="n">proposals</span><span class="p">;</span>

    <span class="c1">/// Create a new ballot to choose one of `proposalNames`.</span>
    <span class="kd">constructor</span><span class="p">(</span><span class="kt">bytes32</span><span class="p">[]</span> <span class="kr">memory</span> <span class="n">proposalNames</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="n">chairperson</span> <span class="o">=</span> <span class="nb">msg.sender</span><span class="p">;</span>
        <span class="n">voters</span><span class="p">[</span><span class="n">chairperson</span><span class="p">].</span><span class="n">weight</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

        <span class="c1">// For each of the provided proposal names,</span>
        <span class="c1">// create a new proposal object and add it</span>
        <span class="c1">// to the end of the array.</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">uint</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">proposalNames</span><span class="p">.</span><span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// `Proposal({...})` creates a temporary</span>
            <span class="c1">// Proposal object and `proposals.push(...)`</span>
            <span class="c1">// appends it to the end of `proposals`.</span>
            <span class="n">proposals</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="n">Proposal</span><span class="p">({</span>
                <span class="n">name</span><span class="o">:</span> <span class="n">proposalNames</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">voteCount</span><span class="o">:</span> <span class="mi">0</span>
            <span class="p">}));</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Give `voter` the right to vote on this ballot.</span>
    <span class="c1">// May only be called by `chairperson`.</span>
    <span class="kd">function</span> <span class="n">giveRightToVote</span><span class="p">(</span><span class="kt">address</span> <span class="n">voter</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="c1">// If the first argument of `require` evaluates</span>
        <span class="c1">// to `false`, execution terminates and all</span>
        <span class="c1">// changes to the state and to Ether balances</span>
        <span class="c1">// are reverted.</span>
        <span class="c1">// This used to consume all gas in old EVM versions, but</span>
        <span class="c1">// not anymore.</span>
        <span class="c1">// It is often a good idea to use `require` to check if</span>
        <span class="c1">// functions are called correctly.</span>
        <span class="c1">// As a second argument, you can also provide an</span>
        <span class="c1">// explanation about what went wrong.</span>
        <span class="nf">require</span><span class="p">(</span>
            <span class="nb">msg.sender</span> <span class="o">==</span> <span class="n">chairperson</span><span class="p">,</span>
            <span class="s">&quot;Only chairperson can give right to vote.&quot;</span>
        <span class="p">);</span>
        <span class="nf">require</span><span class="p">(</span>
            <span class="o">!</span><span class="n">voters</span><span class="p">[</span><span class="n">voter</span><span class="p">].</span><span class="n">voted</span><span class="p">,</span>
            <span class="s">&quot;The voter already voted.&quot;</span>
        <span class="p">);</span>
        <span class="nf">require</span><span class="p">(</span><span class="n">voters</span><span class="p">[</span><span class="n">voter</span><span class="p">].</span><span class="n">weight</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">voters</span><span class="p">[</span><span class="n">voter</span><span class="p">].</span><span class="n">weight</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">/// Delegate your vote to the voter `to`.</span>
    <span class="kd">function</span> <span class="n">delegate</span><span class="p">(</span><span class="kt">address</span> <span class="n">to</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="c1">// assigns reference</span>
        <span class="n">Voter</span> <span class="kr">storage</span> <span class="n">sender</span> <span class="o">=</span> <span class="n">voters</span><span class="p">[</span><span class="nb">msg.sender</span><span class="p">];</span>
        <span class="nf">require</span><span class="p">(</span><span class="o">!</span><span class="n">sender</span><span class="p">.</span><span class="n">voted</span><span class="p">,</span> <span class="s">&quot;You already voted.&quot;</span><span class="p">);</span>

        <span class="nf">require</span><span class="p">(</span><span class="n">to</span> <span class="o">!=</span> <span class="nb">msg.sender</span><span class="p">,</span> <span class="s">&quot;Self-delegation is disallowed.&quot;</span><span class="p">);</span>

        <span class="c1">// Forward the delegation as long as</span>
        <span class="c1">// `to` also delegated.</span>
        <span class="c1">// In general, such loops are very dangerous,</span>
        <span class="c1">// because if they run too long, they might</span>
        <span class="c1">// need more gas than is available in a block.</span>
        <span class="c1">// In this case, the delegation will not be executed,</span>
        <span class="c1">// but in other situations, such loops might</span>
        <span class="c1">// cause a contract to get &quot;stuck&quot; completely.</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">voters</span><span class="p">[</span><span class="n">to</span><span class="p">].</span><span class="n">delegate</span> <span class="o">!=</span> <span class="kt">address</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">to</span> <span class="o">=</span> <span class="n">voters</span><span class="p">[</span><span class="n">to</span><span class="p">].</span><span class="n">delegate</span><span class="p">;</span>

            <span class="c1">// We found a loop in the delegation, not allowed.</span>
            <span class="nf">require</span><span class="p">(</span><span class="n">to</span> <span class="o">!=</span> <span class="nb">msg.sender</span><span class="p">,</span> <span class="s">&quot;Found loop in delegation.&quot;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// Since `sender` is a reference, this</span>
        <span class="c1">// modifies `voters[msg.sender].voted`</span>
        <span class="n">sender</span><span class="p">.</span><span class="n">voted</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="n">sender</span><span class="p">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="n">to</span><span class="p">;</span>
        <span class="n">Voter</span> <span class="kr">storage</span> <span class="n">delegate_</span> <span class="o">=</span> <span class="n">voters</span><span class="p">[</span><span class="n">to</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">delegate_</span><span class="p">.</span><span class="n">voted</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// If the delegate already voted,</span>
            <span class="c1">// directly add to the number of votes</span>
            <span class="n">proposals</span><span class="p">[</span><span class="n">delegate_</span><span class="p">.</span><span class="n">vote</span><span class="p">].</span><span class="n">voteCount</span> <span class="o">+=</span> <span class="n">sender</span><span class="p">.</span><span class="n">weight</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// If the delegate did not vote yet,</span>
            <span class="c1">// add to her weight.</span>
            <span class="n">delegate_</span><span class="p">.</span><span class="n">weight</span> <span class="o">+=</span> <span class="n">sender</span><span class="p">.</span><span class="n">weight</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">/// Give your vote (including votes delegated to you)</span>
    <span class="c1">/// to proposal `proposals[proposal].name`.</span>
    <span class="kd">function</span> <span class="n">vote</span><span class="p">(</span><span class="kt">uint</span> <span class="n">proposal</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="n">Voter</span> <span class="kr">storage</span> <span class="n">sender</span> <span class="o">=</span> <span class="n">voters</span><span class="p">[</span><span class="nb">msg.sender</span><span class="p">];</span>
        <span class="nf">require</span><span class="p">(</span><span class="n">sender</span><span class="p">.</span><span class="n">weight</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Has no right to vote&quot;</span><span class="p">);</span>
        <span class="nf">require</span><span class="p">(</span><span class="o">!</span><span class="n">sender</span><span class="p">.</span><span class="n">voted</span><span class="p">,</span> <span class="s">&quot;Already voted.&quot;</span><span class="p">);</span>
        <span class="n">sender</span><span class="p">.</span><span class="n">voted</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="n">sender</span><span class="p">.</span><span class="n">vote</span> <span class="o">=</span> <span class="n">proposal</span><span class="p">;</span>

        <span class="c1">// If `proposal` is out of the range of the array,</span>
        <span class="c1">// this will throw automatically and revert all</span>
        <span class="c1">// changes.</span>
        <span class="n">proposals</span><span class="p">[</span><span class="n">proposal</span><span class="p">].</span><span class="n">voteCount</span> <span class="o">+=</span> <span class="n">sender</span><span class="p">.</span><span class="n">weight</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">/// </span><span class="cs">@dev</span><span class="c1"> Computes the winning proposal taking all</span>
    <span class="c1">/// previous votes into account.</span>
    <span class="kd">function</span> <span class="n">winningProposal</span><span class="p">()</span> <span class="kr">public</span> <span class="kr">view</span>
            <span class="k">returns</span> <span class="p">(</span><span class="kt">uint</span> <span class="n">winningProposal_</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">uint</span> <span class="n">winningVoteCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">uint</span> <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="n">proposals</span><span class="p">.</span><span class="n">length</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">proposals</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">voteCount</span> <span class="o">&gt;</span> <span class="n">winningVoteCount</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">winningVoteCount</span> <span class="o">=</span> <span class="n">proposals</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">voteCount</span><span class="p">;</span>
                <span class="n">winningProposal_</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Calls winningProposal() function to get the index</span>
    <span class="c1">// of the winner contained in the proposals array and then</span>
    <span class="c1">// returns the name of the winner</span>
    <span class="kd">function</span> <span class="n">winnerName</span><span class="p">()</span> <span class="kr">public</span> <span class="kr">view</span>
            <span class="k">returns</span> <span class="p">(</span><span class="kt">bytes32</span> <span class="n">winnerName_</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">winnerName_</span> <span class="o">=</span> <span class="n">proposals</span><span class="p">[</span><span class="n">winningProposal</span><span class="p">()].</span><span class="n">name</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="possible-improvements">
<h3>Possible Improvements<a class="headerlink" href="#possible-improvements" title="Permalink to this headline">¶</a></h3>
<p>Currently, many transactions are needed to assign the rights
to vote to all participants. Can you think of a better way?</p>
</div>
</div>
<div class="section" id="blind-auction">
<span id="index-1"></span><h2>Blind Auction<a class="headerlink" href="#blind-auction" title="Permalink to this headline">¶</a></h2>
<p>In this section, we will show how easy it is to create a
completely blind auction contract on Ethereum.
We will start with an open auction where everyone
can see the bids that are made and then extend this
contract into a blind auction where it is not
possible to see the actual bid until the bidding
period ends.</p>
<div class="section" id="simple-open-auction">
<span id="simple-auction"></span><h3>Simple Open Auction<a class="headerlink" href="#simple-open-auction" title="Permalink to this headline">¶</a></h3>
<p>The general idea of the following simple auction contract
is that everyone can send their bids during
a bidding period. The bids already include sending
money / ether in order to bind the bidders to their
bid. If the highest bid is raised, the previously
highest bidder gets her money back.
After the end of the bidding period, the
contract has to be called manually for the
beneficiary to receive their money - contracts cannot
activate themselves.</p>
<div class="highlight-Solidity notranslate"><div class="highlight"><pre><span></span><span class="kr">pragma solidity</span> <span class="o">&gt;=</span><span class="mf">0.4</span><span class="p">.</span><span class="mi">22</span> <span class="o">&lt;</span><span class="mf">0.7</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="kd">contract</span> <span class="n">SimpleAuction</span> <span class="p">{</span>
    <span class="c1">// Parameters of the auction. Times are either</span>
    <span class="c1">// absolute unix timestamps (seconds since 1970-01-01)</span>
    <span class="c1">// or time periods in seconds.</span>
    <span class="kt">address</span> <span class="kr">payable</span> <span class="kr">public</span> <span class="n">beneficiary</span><span class="p">;</span>
    <span class="kt">uint</span> <span class="kr">public</span> <span class="n">auctionEndTime</span><span class="p">;</span>

    <span class="c1">// Current state of the auction.</span>
    <span class="kt">address</span> <span class="kr">public</span> <span class="n">highestBidder</span><span class="p">;</span>
    <span class="kt">uint</span> <span class="kr">public</span> <span class="n">highestBid</span><span class="p">;</span>

    <span class="c1">// Allowed withdrawals of previous bids</span>
    <span class="kd">mapping</span><span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">uint</span><span class="p">)</span> <span class="n">pendingReturns</span><span class="p">;</span>

    <span class="c1">// Set to true at the end, disallows any change.</span>
    <span class="c1">// By default initialized to `false`.</span>
    <span class="kt">bool</span> <span class="n">ended</span><span class="p">;</span>

    <span class="c1">// Events that will be emitted on changes.</span>
    <span class="kd">event</span> <span class="n">HighestBidIncreased</span><span class="p">(</span><span class="kt">address</span> <span class="n">bidder</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">amount</span><span class="p">);</span>
    <span class="kd">event</span> <span class="n">AuctionEnded</span><span class="p">(</span><span class="kt">address</span> <span class="n">winner</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">amount</span><span class="p">);</span>

    <span class="c1">// The following is a so-called natspec comment,</span>
    <span class="c1">// recognizable by the three slashes.</span>
    <span class="c1">// It will be shown when the user is asked to</span>
    <span class="c1">// confirm a transaction.</span>

    <span class="c1">/// Create a simple auction with `_biddingTime`</span>
    <span class="c1">/// seconds bidding time on behalf of the</span>
    <span class="c1">/// beneficiary address `_beneficiary`.</span>
    <span class="kd">constructor</span><span class="p">(</span>
        <span class="kt">uint</span> <span class="n">_biddingTime</span><span class="p">,</span>
        <span class="kt">address</span> <span class="kr">payable</span> <span class="n">_beneficiary</span>
    <span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="n">beneficiary</span> <span class="o">=</span> <span class="n">_beneficiary</span><span class="p">;</span>
        <span class="n">auctionEndTime</span> <span class="o">=</span> <span class="nb">now</span> <span class="o">+</span> <span class="n">_biddingTime</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">/// Bid on the auction with the value sent</span>
    <span class="c1">/// together with this transaction.</span>
    <span class="c1">/// The value will only be refunded if the</span>
    <span class="c1">/// auction is not won.</span>
    <span class="kd">function</span> <span class="n">bid</span><span class="p">()</span> <span class="kr">public</span> <span class="kr">payable</span> <span class="p">{</span>
        <span class="c1">// No arguments are necessary, all</span>
        <span class="c1">// information is already part of</span>
        <span class="c1">// the transaction. The keyword payable</span>
        <span class="c1">// is required for the function to</span>
        <span class="c1">// be able to receive Ether.</span>

        <span class="c1">// Revert the call if the bidding</span>
        <span class="c1">// period is over.</span>
        <span class="nf">require</span><span class="p">(</span>
            <span class="nb">now</span> <span class="o">&lt;=</span> <span class="n">auctionEndTime</span><span class="p">,</span>
            <span class="s">&quot;Auction already ended.&quot;</span>
        <span class="p">);</span>

        <span class="c1">// If the bid is not higher, send the</span>
        <span class="c1">// money back.</span>
        <span class="nf">require</span><span class="p">(</span>
            <span class="nb">msg.value</span> <span class="o">&gt;</span> <span class="n">highestBid</span><span class="p">,</span>
            <span class="s">&quot;There already is a higher bid.&quot;</span>
        <span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">highestBid</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Sending back the money by simply using</span>
            <span class="c1">// highestBidder.send(highestBid) is a security risk</span>
            <span class="c1">// because it could execute an untrusted contract.</span>
            <span class="c1">// It is always safer to let the recipients</span>
            <span class="c1">// withdraw their money themselves.</span>
            <span class="n">pendingReturns</span><span class="p">[</span><span class="n">highestBidder</span><span class="p">]</span> <span class="o">+=</span> <span class="n">highestBid</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">highestBidder</span> <span class="o">=</span> <span class="nb">msg.sender</span><span class="p">;</span>
        <span class="n">highestBid</span> <span class="o">=</span> <span class="nb">msg.value</span><span class="p">;</span>
        <span class="kr">emit</span> <span class="n">HighestBidIncreased</span><span class="p">(</span><span class="nb">msg.sender</span><span class="p">,</span> <span class="nb">msg.value</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">/// Withdraw a bid that was overbid.</span>
    <span class="kd">function</span> <span class="n">withdraw</span><span class="p">()</span> <span class="kr">public</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">uint</span> <span class="n">amount</span> <span class="o">=</span> <span class="n">pendingReturns</span><span class="p">[</span><span class="nb">msg.sender</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// It is important to set this to zero because the recipient</span>
            <span class="c1">// can call this function again as part of the receiving call</span>
            <span class="c1">// before `send` returns.</span>
            <span class="n">pendingReturns</span><span class="p">[</span><span class="nb">msg.sender</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">msg.sender</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">amount</span><span class="p">))</span> <span class="p">{</span>
                <span class="c1">// No need to call throw here, just reset the amount owing</span>
                <span class="n">pendingReturns</span><span class="p">[</span><span class="nb">msg.sender</span><span class="p">]</span> <span class="o">=</span> <span class="n">amount</span><span class="p">;</span>
                <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">/// End the auction and send the highest bid</span>
    <span class="c1">/// to the beneficiary.</span>
    <span class="kd">function</span> <span class="n">auctionEnd</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="c1">// It is a good guideline to structure functions that interact</span>
        <span class="c1">// with other contracts (i.e. they call functions or send Ether)</span>
        <span class="c1">// into three phases:</span>
        <span class="c1">// 1. checking conditions</span>
        <span class="c1">// 2. performing actions (potentially changing conditions)</span>
        <span class="c1">// 3. interacting with other contracts</span>
        <span class="c1">// If these phases are mixed up, the other contract could call</span>
        <span class="c1">// back into the current contract and modify the state or cause</span>
        <span class="c1">// effects (ether payout) to be performed multiple times.</span>
        <span class="c1">// If functions called internally include interaction with external</span>
        <span class="c1">// contracts, they also have to be considered interaction with</span>
        <span class="c1">// external contracts.</span>

        <span class="c1">// 1. Conditions</span>
        <span class="nf">require</span><span class="p">(</span><span class="nb">now</span> <span class="o">&gt;=</span> <span class="n">auctionEndTime</span><span class="p">,</span> <span class="s">&quot;Auction not yet ended.&quot;</span><span class="p">);</span>
        <span class="nf">require</span><span class="p">(</span><span class="o">!</span><span class="n">ended</span><span class="p">,</span> <span class="s">&quot;auctionEnd has already been called.&quot;</span><span class="p">);</span>

        <span class="c1">// 2. Effects</span>
        <span class="n">ended</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="kr">emit</span> <span class="n">AuctionEnded</span><span class="p">(</span><span class="n">highestBidder</span><span class="p">,</span> <span class="n">highestBid</span><span class="p">);</span>

        <span class="c1">// 3. Interaction</span>
        <span class="n">beneficiary</span><span class="p">.</span><span class="nf">transfer</span><span class="p">(</span><span class="n">highestBid</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h3>Blind Auction<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>The previous open auction is extended to a blind auction
in the following. The advantage of a blind auction is
that there is no time pressure towards the end of
the bidding period. Creating a blind auction on a
transparent computing platform might sound like a
contradiction, but cryptography comes to the rescue.</p>
<p>During the <strong>bidding period</strong>, a bidder does not
actually send her bid, but only a hashed version of it.
Since it is currently considered practically impossible
to find two (sufficiently long) values whose hash
values are equal, the bidder commits to the bid by that.
After the end of the bidding period, the bidders have
to reveal their bids: They send their values
unencrypted and the contract checks that the hash value
is the same as the one provided during the bidding period.</p>
<p>Another challenge is how to make the auction
<strong>binding and blind</strong> at the same time: The only way to
prevent the bidder from just not sending the money
after they won the auction is to make her send it
together with the bid. Since value transfers cannot
be blinded in Ethereum, anyone can see the value.</p>
<p>The following contract solves this problem by
accepting any value that is larger than the highest
bid. Since this can of course only be checked during
the reveal phase, some bids might be <strong>invalid</strong>, and
this is on purpose (it even provides an explicit
flag to place invalid bids with high value transfers):
Bidders can confuse competition by placing several
high or low invalid bids.</p>
<div class="highlight-Solidity notranslate"><div class="highlight"><pre><span></span><span class="kr">pragma solidity</span> <span class="o">&gt;</span><span class="mf">0.4</span><span class="p">.</span><span class="mi">23</span> <span class="o">&lt;</span><span class="mf">0.7</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="kd">contract</span> <span class="n">BlindAuction</span> <span class="p">{</span>
    <span class="kd">struct</span> <span class="n">Bid</span> <span class="p">{</span>
        <span class="kt">bytes32</span> <span class="n">blindedBid</span><span class="p">;</span>
        <span class="kt">uint</span> <span class="n">deposit</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">address</span> <span class="kr">payable</span> <span class="kr">public</span> <span class="n">beneficiary</span><span class="p">;</span>
    <span class="kt">uint</span> <span class="kr">public</span> <span class="n">biddingEnd</span><span class="p">;</span>
    <span class="kt">uint</span> <span class="kr">public</span> <span class="n">revealEnd</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="kr">public</span> <span class="n">ended</span><span class="p">;</span>

    <span class="kd">mapping</span><span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="n">Bid</span><span class="p">[])</span> <span class="kr">public</span> <span class="n">bids</span><span class="p">;</span>

    <span class="kt">address</span> <span class="kr">public</span> <span class="n">highestBidder</span><span class="p">;</span>
    <span class="kt">uint</span> <span class="kr">public</span> <span class="n">highestBid</span><span class="p">;</span>

    <span class="c1">// Allowed withdrawals of previous bids</span>
    <span class="kd">mapping</span><span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">uint</span><span class="p">)</span> <span class="n">pendingReturns</span><span class="p">;</span>

    <span class="kd">event</span> <span class="n">AuctionEnded</span><span class="p">(</span><span class="kt">address</span> <span class="n">winner</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">highestBid</span><span class="p">);</span>

    <span class="c1">/// Modifiers are a convenient way to validate inputs to</span>
    <span class="c1">/// functions. `onlyBefore` is applied to `bid` below:</span>
    <span class="c1">/// The new function body is the modifier&#39;s body where</span>
    <span class="c1">/// `_` is replaced by the old function body.</span>
    <span class="kd">modifier</span> <span class="n">onlyBefore</span><span class="p">(</span><span class="kt">uint</span> <span class="n">_time</span><span class="p">)</span> <span class="p">{</span> <span class="nf">require</span><span class="p">(</span><span class="nb">now</span> <span class="o">&lt;</span> <span class="n">_time</span><span class="p">);</span> <span class="kr">_</span><span class="p">;</span> <span class="p">}</span>
    <span class="kd">modifier</span> <span class="n">onlyAfter</span><span class="p">(</span><span class="kt">uint</span> <span class="n">_time</span><span class="p">)</span> <span class="p">{</span> <span class="nf">require</span><span class="p">(</span><span class="nb">now</span> <span class="o">&gt;</span> <span class="n">_time</span><span class="p">);</span> <span class="kr">_</span><span class="p">;</span> <span class="p">}</span>

    <span class="kd">constructor</span><span class="p">(</span>
        <span class="kt">uint</span> <span class="n">_biddingTime</span><span class="p">,</span>
        <span class="kt">uint</span> <span class="n">_revealTime</span><span class="p">,</span>
        <span class="kt">address</span> <span class="kr">payable</span> <span class="n">_beneficiary</span>
    <span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="n">beneficiary</span> <span class="o">=</span> <span class="n">_beneficiary</span><span class="p">;</span>
        <span class="n">biddingEnd</span> <span class="o">=</span> <span class="nb">now</span> <span class="o">+</span> <span class="n">_biddingTime</span><span class="p">;</span>
        <span class="n">revealEnd</span> <span class="o">=</span> <span class="n">biddingEnd</span> <span class="o">+</span> <span class="n">_revealTime</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">/// Place a blinded bid with `_blindedBid` =</span>
    <span class="c1">/// keccak256(abi.encodePacked(value, fake, secret)).</span>
    <span class="c1">/// The sent ether is only refunded if the bid is correctly</span>
    <span class="c1">/// revealed in the revealing phase. The bid is valid if the</span>
    <span class="c1">/// ether sent together with the bid is at least &quot;value&quot; and</span>
    <span class="c1">/// &quot;fake&quot; is not true. Setting &quot;fake&quot; to true and sending</span>
    <span class="c1">/// not the exact amount are ways to hide the real bid but</span>
    <span class="c1">/// still make the required deposit. The same address can</span>
    <span class="c1">/// place multiple bids.</span>
    <span class="kd">function</span> <span class="n">bid</span><span class="p">(</span><span class="kt">bytes32</span> <span class="n">_blindedBid</span><span class="p">)</span>
        <span class="kr">public</span>
        <span class="kr">payable</span>
        <span class="n">onlyBefore</span><span class="p">(</span><span class="n">biddingEnd</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">bids</span><span class="p">[</span><span class="nb">msg.sender</span><span class="p">].</span><span class="nf">push</span><span class="p">(</span><span class="n">Bid</span><span class="p">({</span>
            <span class="n">blindedBid</span><span class="o">:</span> <span class="n">_blindedBid</span><span class="p">,</span>
            <span class="n">deposit</span><span class="o">:</span> <span class="nb">msg.value</span>
        <span class="p">}));</span>
    <span class="p">}</span>

    <span class="c1">/// Reveal your blinded bids. You will get a refund for all</span>
    <span class="c1">/// correctly blinded invalid bids and for all bids except for</span>
    <span class="c1">/// the totally highest.</span>
    <span class="kd">function</span> <span class="n">reveal</span><span class="p">(</span>
        <span class="kt">uint</span><span class="p">[]</span> <span class="kr">memory</span> <span class="n">_values</span><span class="p">,</span>
        <span class="kt">bool</span><span class="p">[]</span> <span class="kr">memory</span> <span class="n">_fake</span><span class="p">,</span>
        <span class="kt">bytes32</span><span class="p">[]</span> <span class="kr">memory</span> <span class="n">_secret</span>
    <span class="p">)</span>
        <span class="kr">public</span>
        <span class="n">onlyAfter</span><span class="p">(</span><span class="n">biddingEnd</span><span class="p">)</span>
        <span class="n">onlyBefore</span><span class="p">(</span><span class="n">revealEnd</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">uint</span> <span class="n">length</span> <span class="o">=</span> <span class="n">bids</span><span class="p">[</span><span class="nb">msg.sender</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>
        <span class="nf">require</span><span class="p">(</span><span class="n">_values</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="n">length</span><span class="p">);</span>
        <span class="nf">require</span><span class="p">(</span><span class="n">_fake</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="n">length</span><span class="p">);</span>
        <span class="nf">require</span><span class="p">(</span><span class="n">_secret</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="n">length</span><span class="p">);</span>

        <span class="kt">uint</span> <span class="n">refund</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">uint</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">Bid</span> <span class="kr">storage</span> <span class="n">bidToCheck</span> <span class="o">=</span> <span class="n">bids</span><span class="p">[</span><span class="nb">msg.sender</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
            <span class="p">(</span><span class="kt">uint</span> <span class="n">value</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">fake</span><span class="p">,</span> <span class="kt">bytes32</span> <span class="n">secret</span><span class="p">)</span> <span class="o">=</span>
                    <span class="p">(</span><span class="n">_values</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">_fake</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">_secret</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">bidToCheck</span><span class="p">.</span><span class="n">blindedBid</span> <span class="o">!=</span> <span class="nf">keccak256</span><span class="p">(</span><span class="nb">abi.encodePacked</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">fake</span><span class="p">,</span> <span class="n">secret</span><span class="p">)))</span> <span class="p">{</span>
                <span class="c1">// Bid was not actually revealed.</span>
                <span class="c1">// Do not refund deposit.</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">refund</span> <span class="o">+=</span> <span class="n">bidToCheck</span><span class="p">.</span><span class="n">deposit</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fake</span> <span class="o">&amp;&amp;</span> <span class="n">bidToCheck</span><span class="p">.</span><span class="n">deposit</span> <span class="o">&gt;=</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">placeBid</span><span class="p">(</span><span class="nb">msg.sender</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
                    <span class="n">refund</span> <span class="o">-=</span> <span class="n">value</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="c1">// Make it impossible for the sender to re-claim</span>
            <span class="c1">// the same deposit.</span>
            <span class="n">bidToCheck</span><span class="p">.</span><span class="n">blindedBid</span> <span class="o">=</span> <span class="kt">bytes32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nb">msg.sender</span><span class="p">.</span><span class="nf">transfer</span><span class="p">(</span><span class="n">refund</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// This is an &quot;internal&quot; function which means that it</span>
    <span class="c1">// can only be called from the contract itself (or from</span>
    <span class="c1">// derived contracts).</span>
    <span class="kd">function</span> <span class="n">placeBid</span><span class="p">(</span><span class="kt">address</span> <span class="n">bidder</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">value</span><span class="p">)</span> <span class="kr">internal</span>
            <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span> <span class="n">success</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;=</span> <span class="n">highestBid</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">highestBidder</span> <span class="o">!=</span> <span class="kt">address</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
            <span class="c1">// Refund the previously highest bidder.</span>
            <span class="n">pendingReturns</span><span class="p">[</span><span class="n">highestBidder</span><span class="p">]</span> <span class="o">+=</span> <span class="n">highestBid</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">highestBid</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
        <span class="n">highestBidder</span> <span class="o">=</span> <span class="n">bidder</span><span class="p">;</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">/// Withdraw a bid that was overbid.</span>
    <span class="kd">function</span> <span class="n">withdraw</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="kt">uint</span> <span class="n">amount</span> <span class="o">=</span> <span class="n">pendingReturns</span><span class="p">[</span><span class="nb">msg.sender</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// It is important to set this to zero because the recipient</span>
            <span class="c1">// can call this function again as part of the receiving call</span>
            <span class="c1">// before `transfer` returns (see the remark above about</span>
            <span class="c1">// conditions -&gt; effects -&gt; interaction).</span>
            <span class="n">pendingReturns</span><span class="p">[</span><span class="nb">msg.sender</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

            <span class="nb">msg.sender</span><span class="p">.</span><span class="nf">transfer</span><span class="p">(</span><span class="n">amount</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">/// End the auction and send the highest bid</span>
    <span class="c1">/// to the beneficiary.</span>
    <span class="kd">function</span> <span class="n">auctionEnd</span><span class="p">()</span>
        <span class="kr">public</span>
        <span class="n">onlyAfter</span><span class="p">(</span><span class="n">revealEnd</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nf">require</span><span class="p">(</span><span class="o">!</span><span class="n">ended</span><span class="p">);</span>
        <span class="kr">emit</span> <span class="n">AuctionEnded</span><span class="p">(</span><span class="n">highestBidder</span><span class="p">,</span> <span class="n">highestBid</span><span class="p">);</span>
        <span class="n">ended</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="n">beneficiary</span><span class="p">.</span><span class="nf">transfer</span><span class="p">(</span><span class="n">highestBid</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="safe-remote-purchase">
<span id="index-2"></span><h2>Safe Remote Purchase<a class="headerlink" href="#safe-remote-purchase" title="Permalink to this headline">¶</a></h2>
<div class="highlight-Solidity notranslate"><div class="highlight"><pre><span></span><span class="kr">pragma solidity</span> <span class="o">&gt;=</span><span class="mf">0.4</span><span class="p">.</span><span class="mi">22</span> <span class="o">&lt;</span><span class="mf">0.7</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="kd">contract</span> <span class="n">Purchase</span> <span class="p">{</span>
    <span class="kt">uint</span> <span class="kr">public</span> <span class="n">value</span><span class="p">;</span>
    <span class="kt">address</span> <span class="kr">payable</span> <span class="kr">public</span> <span class="n">seller</span><span class="p">;</span>
    <span class="kt">address</span> <span class="kr">payable</span> <span class="kr">public</span> <span class="n">buyer</span><span class="p">;</span>
    <span class="kd">enum</span> <span class="n">State</span> <span class="p">{</span> <span class="n">Created</span><span class="p">,</span> <span class="n">Locked</span><span class="p">,</span> <span class="n">Inactive</span> <span class="p">}</span>
    <span class="n">State</span> <span class="kr">public</span> <span class="n">state</span><span class="p">;</span>

    <span class="c1">// Ensure that `msg.value` is an even number.</span>
    <span class="c1">// Division will truncate if it is an odd number.</span>
    <span class="c1">// Check via multiplication that it wasn&#39;t an odd number.</span>
    <span class="kd">constructor</span><span class="p">()</span> <span class="kr">public</span> <span class="kr">payable</span> <span class="p">{</span>
        <span class="n">seller</span> <span class="o">=</span> <span class="nb">msg.sender</span><span class="p">;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">msg.value</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
        <span class="nf">require</span><span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">msg.value</span><span class="p">,</span> <span class="s">&quot;Value has to be even.&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">modifier</span> <span class="n">condition</span><span class="p">(</span><span class="kt">bool</span> <span class="n">_condition</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">require</span><span class="p">(</span><span class="n">_condition</span><span class="p">);</span>
        <span class="kr">_</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">modifier</span> <span class="n">onlyBuyer</span><span class="p">()</span> <span class="p">{</span>
        <span class="nf">require</span><span class="p">(</span>
            <span class="nb">msg.sender</span> <span class="o">==</span> <span class="n">buyer</span><span class="p">,</span>
            <span class="s">&quot;Only buyer can call this.&quot;</span>
        <span class="p">);</span>
        <span class="kr">_</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">modifier</span> <span class="n">onlySeller</span><span class="p">()</span> <span class="p">{</span>
        <span class="nf">require</span><span class="p">(</span>
            <span class="nb">msg.sender</span> <span class="o">==</span> <span class="n">seller</span><span class="p">,</span>
            <span class="s">&quot;Only seller can call this.&quot;</span>
        <span class="p">);</span>
        <span class="kr">_</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">modifier</span> <span class="n">inState</span><span class="p">(</span><span class="n">State</span> <span class="n">_state</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">require</span><span class="p">(</span>
            <span class="n">state</span> <span class="o">==</span> <span class="n">_state</span><span class="p">,</span>
            <span class="s">&quot;Invalid state.&quot;</span>
        <span class="p">);</span>
        <span class="kr">_</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">event</span> <span class="n">Aborted</span><span class="p">();</span>
    <span class="kd">event</span> <span class="n">PurchaseConfirmed</span><span class="p">();</span>
    <span class="kd">event</span> <span class="n">ItemReceived</span><span class="p">();</span>

    <span class="c1">/// Abort the purchase and reclaim the ether.</span>
    <span class="c1">/// Can only be called by the seller before</span>
    <span class="c1">/// the contract is locked.</span>
    <span class="kd">function</span> <span class="n">abort</span><span class="p">()</span>
        <span class="kr">public</span>
        <span class="n">onlySeller</span>
        <span class="n">inState</span><span class="p">(</span><span class="n">State</span><span class="p">.</span><span class="n">Created</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kr">emit</span> <span class="n">Aborted</span><span class="p">();</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="p">.</span><span class="n">Inactive</span><span class="p">;</span>
        <span class="n">seller</span><span class="p">.</span><span class="nf">transfer</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">).</span><span class="nb">balance</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">/// Confirm the purchase as buyer.</span>
    <span class="c1">/// Transaction has to include `2 * value` ether.</span>
    <span class="c1">/// The ether will be locked until confirmReceived</span>
    <span class="c1">/// is called.</span>
    <span class="kd">function</span> <span class="n">confirmPurchase</span><span class="p">()</span>
        <span class="kr">public</span>
        <span class="n">inState</span><span class="p">(</span><span class="n">State</span><span class="p">.</span><span class="n">Created</span><span class="p">)</span>
        <span class="n">condition</span><span class="p">(</span><span class="nb">msg.value</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">value</span><span class="p">))</span>
        <span class="kr">payable</span>
    <span class="p">{</span>
        <span class="kr">emit</span> <span class="n">PurchaseConfirmed</span><span class="p">();</span>
        <span class="n">buyer</span> <span class="o">=</span> <span class="nb">msg.sender</span><span class="p">;</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="p">.</span><span class="n">Locked</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">/// Confirm that you (the buyer) received the item.</span>
    <span class="c1">/// This will release the locked ether.</span>
    <span class="kd">function</span> <span class="n">confirmReceived</span><span class="p">()</span>
        <span class="kr">public</span>
        <span class="n">onlyBuyer</span>
        <span class="n">inState</span><span class="p">(</span><span class="n">State</span><span class="p">.</span><span class="n">Locked</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kr">emit</span> <span class="n">ItemReceived</span><span class="p">();</span>
        <span class="c1">// It is important to change the state first because</span>
        <span class="c1">// otherwise, the contracts called using `send` below</span>
        <span class="c1">// can call in again here.</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="p">.</span><span class="n">Inactive</span><span class="p">;</span>

        <span class="c1">// NOTE: This actually allows both the buyer and the seller to</span>
        <span class="c1">// block the refund - the withdraw pattern should be used.</span>

        <span class="n">buyer</span><span class="p">.</span><span class="nf">transfer</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
        <span class="n">seller</span><span class="p">.</span><span class="nf">transfer</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">).</span><span class="nb">balance</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="micropayment-channel">
<h2>Micropayment Channel<a class="headerlink" href="#micropayment-channel" title="Permalink to this headline">¶</a></h2>
<p>In this section we will learn how to build an example implementation
of a payment channel. It uses cryptographic signatures to make
repeated transfers of Ether between the same parties secure, instantaneous, and
without transaction fees. For the example, we need to understand how to
sign and verify signatures, and setup the payment channel.</p>
<div class="section" id="creating-and-verifying-signatures">
<h3>Creating and verifying signatures<a class="headerlink" href="#creating-and-verifying-signatures" title="Permalink to this headline">¶</a></h3>
<p>Imagine Alice wants to send a quantity of Ether to Bob, i.e.
Alice is the sender and the Bob is the recipient.</p>
<p>Alice only needs to send cryptographically signed messages off-chain
(e.g. via email) to Bob and it is similar to writing checks.</p>
<p>Alice and Bob use signatures to authorise transactions, which is possible with smart contracts on Ethereum.
Alice will build a simple smart contract that lets her transmit Ether, but instead of calling a function herself
to initiate a payment, she will let Bob do that, and therefore pay the transaction fee.</p>
<p>The contract will work as follows:</p>
<blockquote>
<div><ol class="arabic simple">
<li>Alice deploys the <code class="docutils literal notranslate"><span class="pre">ReceiverPays</span></code> contract, attaching enough Ether to cover the payments that will be made.</li>
<li>Alice authorises a payment by signing a message with their private key.</li>
<li>Alice sends the cryptographically signed message to Bob. The message does not need to be kept secret
(explained later), and the mechanism for sending it does not matter.</li>
<li>Bob claims their payment by presenting the signed message to the smart contract, it verifies the
authenticity of the message and then releases the funds.</li>
</ol>
</div></blockquote>
<div class="section" id="creating-the-signature">
<h4>Creating the signature<a class="headerlink" href="#creating-the-signature" title="Permalink to this headline">¶</a></h4>
<p>Alice does not need to interact with the Ethereum network to sign the transaction, the process is completely offline.
In this tutorial, we will sign messages in the browser using <a class="reference external" href="https://github.com/ethereum/web3.js">web3.js</a> and <a class="reference external" href="https://metamask.io/">MetaMask</a>, using the method described in <a class="reference external" href="https://github.com/ethereum/EIPs/pull/712">EIP-762</a>,
as it provides a number of other security benefits.</p>
<div class="highlight-Solidity notranslate"><div class="highlight"><pre><span></span><span class="c1">/// Hashing first makes things easier</span>
<span class="kd">var</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">web3</span><span class="p">.</span><span class="n">utils</span><span class="p">.</span><span class="nf">sha3</span><span class="p">(</span><span class="s">&quot;message to sign&quot;</span><span class="p">);</span>
<span class="n">web3</span><span class="p">.</span><span class="n">eth</span><span class="p">.</span><span class="n">personal</span><span class="p">.</span><span class="n">sign</span><span class="p">(</span><span class="n">hash</span><span class="p">,</span> <span class="n">web3</span><span class="p">.</span><span class="n">eth</span><span class="p">.</span><span class="n">defaultAccount</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;Signed&quot;</span><span class="p">);</span> <span class="p">});</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <code class="docutils literal notranslate"><span class="pre">web3.eth.personal.sign</span></code> prepends the length of the message to the signed data. Since we hash first, the message will always be exactly 32 bytes long, and thus this length prefix is always the same.</p>
</div>
</div>
<div class="section" id="what-to-sign">
<h4>What to Sign<a class="headerlink" href="#what-to-sign" title="Permalink to this headline">¶</a></h4>
<p>For a contract that fulfils payments, the signed message must include:</p>
<blockquote>
<div><ol class="arabic simple">
<li>The recipient’s address.</li>
<li>The amount to be transferred.</li>
<li>Protection against replay attacks.</li>
</ol>
</div></blockquote>
<p>A replay attack is when a signed message is reused to claim authorization for
a second action.
To avoid replay attacks we use the same as in Ethereum transactions
themselves, a so-called nonce, which is the number of transactions sent by an
account.
The smart contract checks if a nonce is used multiple times.</p>
<p>Another type of replay attack can occur when the owner deploys a <code class="docutils literal notranslate"><span class="pre">ReceiverPays</span></code> smart contract, makes some payments, and then destroys the contract. Later, they decide to deploy the <code class="docutils literal notranslate"><span class="pre">RecipientPays</span></code> smart contract again, but the new contract does not know the nonces used in the previous deployment, so the attacker can use the old messages again.</p>
<p>Alice can protect against this attack by including the contract’s address in the message, and only messages containing the contract’s address itself will be accepted. You can find an example of this in the first two lines of the <code class="docutils literal notranslate"><span class="pre">claimPayment()</span></code> function of the full contract at the end of this section.</p>
</div>
<div class="section" id="packing-arguments">
<h4>Packing arguments<a class="headerlink" href="#packing-arguments" title="Permalink to this headline">¶</a></h4>
<p>Now that we have identified what information to include in the signed message,
we are ready to put the message together, hash it, and sign it. For simplicity,
we concatenate the data. The <a class="reference external" href="https://github.com/ethereumjs/ethereumjs-abi">ethereumjs-abi</a>
library provides a function called <code class="docutils literal notranslate"><span class="pre">soliditySHA3</span></code> that mimics the behaviour of
Solidity’s <code class="docutils literal notranslate"><span class="pre">keccak256</span></code> function applied to arguments encoded using <code class="docutils literal notranslate"><span class="pre">abi.encodePacked</span></code>.
Here is a JavaScript function that creates the proper signature for the <code class="docutils literal notranslate"><span class="pre">ReceiverPays</span></code> example:</p>
<div class="highlight-Solidity notranslate"><div class="highlight"><pre><span></span><span class="c1">// recipient is the address that should be paid.</span>
<span class="c1">// amount, in wei, specifies how much ether should be sent.</span>
<span class="c1">// nonce can be any unique number to prevent replay attacks</span>
<span class="c1">// contractAddress is used to prevent cross-contract replay attacks</span>
<span class="kd">function</span> <span class="n">signPayment</span><span class="p">(</span><span class="n">recipient</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">nonce</span><span class="p">,</span> <span class="n">contractAddress</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="n">hash</span> <span class="o">=</span> <span class="s">&quot;0x&quot;</span> <span class="o">+</span> <span class="n">abi</span><span class="p">.</span><span class="n">soliditySHA3</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&quot;address&quot;</span><span class="p">,</span> <span class="s">&quot;uint256&quot;</span><span class="p">,</span> <span class="s">&quot;uint256&quot;</span><span class="p">,</span> <span class="s">&quot;address&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="n">recipient</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">nonce</span><span class="p">,</span> <span class="n">contractAddress</span><span class="p">]</span>
    <span class="p">).</span><span class="n">toString</span><span class="p">(</span><span class="s">&quot;hex&quot;</span><span class="p">);</span>

    <span class="n">web3</span><span class="p">.</span><span class="n">eth</span><span class="p">.</span><span class="n">personal</span><span class="p">.</span><span class="n">sign</span><span class="p">(</span><span class="n">hash</span><span class="p">,</span> <span class="n">web3</span><span class="p">.</span><span class="n">eth</span><span class="p">.</span><span class="n">defaultAccount</span><span class="p">,</span> <span class="n">callback</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="recovering-the-message-signer-in-solidity">
<h4>Recovering the Message Signer in Solidity<a class="headerlink" href="#recovering-the-message-signer-in-solidity" title="Permalink to this headline">¶</a></h4>
<p>In general, ECDSA signatures consist of two parameters, <code class="docutils literal notranslate"><span class="pre">r</span></code> and <code class="docutils literal notranslate"><span class="pre">s</span></code>. Signatures in Ethereum include a third parameter called <code class="docutils literal notranslate"><span class="pre">v</span></code>, that you can use to verify which account’s private key was used to sign the message, and the transaction’s sender. Solidity provides a built-in function <a class="reference external" href="mathematical-and-cryptographic-functions.html">ecrecover</a> that accepts a message along with the <code class="docutils literal notranslate"><span class="pre">r</span></code>, <code class="docutils literal notranslate"><span class="pre">s</span></code> and <code class="docutils literal notranslate"><span class="pre">v</span></code> parameters and returns the address that was used to sign the message.</p>
</div>
<div class="section" id="extracting-the-signature-parameters">
<h4>Extracting the Signature Parameters<a class="headerlink" href="#extracting-the-signature-parameters" title="Permalink to this headline">¶</a></h4>
<p>Signatures produced by web3.js are the concatenation of <code class="docutils literal notranslate"><span class="pre">r</span></code>, <code class="docutils literal notranslate"><span class="pre">s</span></code> and <code class="docutils literal notranslate"><span class="pre">v</span></code>, so the first step is to split these parameters apart. You can do this on the client-side, but doing it inside the smart contract means you only need to send one signature parameter rather than three. Splitting apart a byte array into component parts is a mess, so we use <a class="reference external" href="assembly-2.html">inline assembly</a> to do the job in the <code class="docutils literal notranslate"><span class="pre">splitSignature</span></code> function (the third function in the full contract at the end of this section).</p>
</div>
<div class="section" id="computing-the-message-hash">
<h4>Computing the Message Hash<a class="headerlink" href="#computing-the-message-hash" title="Permalink to this headline">¶</a></h4>
<p>The smart contract needs to know exactly what parameters were signed, and so it
must recreate the message from the parameters and use that for signature verification.
The functions <code class="docutils literal notranslate"><span class="pre">prefixed</span></code> and <code class="docutils literal notranslate"><span class="pre">recoverSigner</span></code> do this in the <code class="docutils literal notranslate"><span class="pre">claimPayment</span></code> function.</p>
</div>
<div class="section" id="the-full-contract">
<h4>The full contract<a class="headerlink" href="#the-full-contract" title="Permalink to this headline">¶</a></h4>
<div class="highlight-Solidity notranslate"><div class="highlight"><pre><span></span><span class="kr">pragma solidity</span> <span class="o">&gt;=</span><span class="mf">0.4</span><span class="p">.</span><span class="mi">24</span> <span class="o">&lt;</span><span class="mf">0.7</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="kd">contract</span> <span class="n">ReceiverPays</span> <span class="p">{</span>
    <span class="kt">address</span> <span class="n">owner</span> <span class="o">=</span> <span class="nb">msg.sender</span><span class="p">;</span>

    <span class="kd">mapping</span><span class="p">(</span><span class="kt">uint256</span> <span class="o">=&gt;</span> <span class="kt">bool</span><span class="p">)</span> <span class="n">usedNonces</span><span class="p">;</span>

    <span class="kd">constructor</span><span class="p">()</span> <span class="kr">public</span> <span class="kr">payable</span> <span class="p">{}</span>

    <span class="kd">function</span> <span class="n">claimPayment</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">amount</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">nonce</span><span class="p">,</span> <span class="kt">bytes</span> <span class="kr">memory</span> <span class="n">signature</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nf">require</span><span class="p">(</span><span class="o">!</span><span class="n">usedNonces</span><span class="p">[</span><span class="n">nonce</span><span class="p">]);</span>
        <span class="n">usedNonces</span><span class="p">[</span><span class="n">nonce</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

        <span class="c1">// this recreates the message that was signed on the client</span>
        <span class="kt">bytes32</span> <span class="n">message</span> <span class="o">=</span> <span class="n">prefixed</span><span class="p">(</span><span class="nf">keccak256</span><span class="p">(</span><span class="nb">abi.encodePacked</span><span class="p">(</span><span class="nb">msg.sender</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">nonce</span><span class="p">,</span> <span class="nb">this</span><span class="p">)));</span>

        <span class="nf">require</span><span class="p">(</span><span class="n">recoverSigner</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">signature</span><span class="p">)</span> <span class="o">==</span> <span class="n">owner</span><span class="p">);</span>

        <span class="nb">msg.sender</span><span class="p">.</span><span class="nf">transfer</span><span class="p">(</span><span class="n">amount</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">/// destroy the contract and reclaim the leftover funds.</span>
    <span class="kd">function</span> <span class="n">kill</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nf">require</span><span class="p">(</span><span class="nb">msg.sender</span> <span class="o">==</span> <span class="n">owner</span><span class="p">);</span>
        <span class="nb">selfdestruct</span><span class="p">(</span><span class="nb">msg.sender</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">/// signature methods.</span>
    <span class="kd">function</span> <span class="n">splitSignature</span><span class="p">(</span><span class="kt">bytes</span> <span class="kr">memory</span> <span class="n">sig</span><span class="p">)</span>
        <span class="kr">internal</span>
        <span class="kr">pure</span>
        <span class="k">returns</span> <span class="p">(</span><span class="kt">uint8</span> <span class="n">v</span><span class="p">,</span> <span class="kt">bytes32</span> <span class="n">r</span><span class="p">,</span> <span class="kt">bytes32</span> <span class="n">s</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nf">require</span><span class="p">(</span><span class="n">sig</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">65</span><span class="p">);</span>

        <span class="k">assembly</span> <span class="p">{</span>
            <span class="c1">// first 32 bytes, after the length prefix.</span>
            <span class="n">r</span> <span class="o">:=</span> <span class="nf">mload</span><span class="p">(</span><span class="nf">add</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="mi">32</span><span class="p">))</span>
            <span class="c1">// second 32 bytes.</span>
            <span class="n">s</span> <span class="o">:=</span> <span class="nf">mload</span><span class="p">(</span><span class="nf">add</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="mi">64</span><span class="p">))</span>
            <span class="c1">// final byte (first byte of the next 32 bytes).</span>
            <span class="n">v</span> <span class="o">:=</span> <span class="nf">byte</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nf">mload</span><span class="p">(</span><span class="nf">add</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="mi">96</span><span class="p">)))</span>
        <span class="p">}</span>

        <span class="nf">return</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span><span class="err">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="n">recoverSigner</span><span class="p">(</span><span class="kt">bytes32</span> <span class="n">message</span><span class="p">,</span> <span class="kt">bytes</span> <span class="kr">memory</span> <span class="n">sig</span><span class="p">)</span>
        <span class="kr">internal</span>
        <span class="kr">pure</span>
        <span class="k">returns</span> <span class="p">(</span><span class="kt">address</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="p">(</span><span class="kt">uint8</span> <span class="n">v</span><span class="p">,</span> <span class="kt">bytes32</span> <span class="n">r</span><span class="p">,</span> <span class="kt">bytes32</span> <span class="n">s</span><span class="p">)</span> <span class="o">=</span> <span class="n">splitSignature</span><span class="p">(</span><span class="n">sig</span><span class="p">);</span>

        <span class="k">return</span> <span class="nf">ecrecover</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">/// builds a prefixed hash to mimic the behavior of eth_sign.</span>
    <span class="kd">function</span> <span class="n">prefixed</span><span class="p">(</span><span class="kt">bytes32</span> <span class="n">hash</span><span class="p">)</span> <span class="kr">internal</span> <span class="kr">pure</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bytes32</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">keccak256</span><span class="p">(</span><span class="nb">abi.encodePacked</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\x19</span><span class="s">Ethereum Signed Message:</span><span class="se">\n</span><span class="s">32&quot;</span><span class="p">,</span> <span class="n">hash</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="writing-a-simple-payment-channel">
<h3>Writing a Simple Payment Channel<a class="headerlink" href="#writing-a-simple-payment-channel" title="Permalink to this headline">¶</a></h3>
<p>Alice now builds a simple but complete implementation of a payment channel. Payment channels use cryptographic signatures to make repeated transfers of Ether securely, instantaneously, and without transaction fees.</p>
<div class="section" id="what-is-a-payment-channel">
<h4>What is a Payment Channel?<a class="headerlink" href="#what-is-a-payment-channel" title="Permalink to this headline">¶</a></h4>
<p>Payment channels allow participants to make repeated transfers of Ether without using transactions. This means that you can avoid the delays and fees associated with transactions. We are going to explore a simple unidirectional payment channel between two parties (Alice and Bob). It involves three steps:</p>
<blockquote>
<div><ol class="arabic simple">
<li>Alice funds a smart contract with Ether. This “opens” the payment channel.</li>
<li>Alice signs messages that specify how much of that Ether is owed to the recipient. This step is repeated for each payment.</li>
<li>Bob “closes” the payment channel, withdrawing their portion of the Ether and sending the remainder back to the sender.</li>
</ol>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Only steps 1 and 3 require Ethereum transactions, step 2 means that the sender transmits a cryptographically signed message to the recipient via off chain methods (e.g. email). This means only two transactions are required to support any number of transfers.</p>
</div>
<p>Bob is guaranteed to receive their funds because the smart contract escrows the Ether and honours a valid signed message. The smart contract also enforces a timeout, so Alice is guaranteed to eventually recover their funds even if the recipient refuses to close the channel. It is up to the participants in a payment channel to decide how long to keep it open. For a short-lived transaction, such as paying an internet café for each minute of network access, or for a longer relationship, such as paying an employee an hourly wage, a payment could last for months or years.</p>
</div>
<div class="section" id="opening-the-payment-channel">
<h4>Opening the Payment Channel<a class="headerlink" href="#opening-the-payment-channel" title="Permalink to this headline">¶</a></h4>
<p>To open the payment channel, Alice deploys the smart contract, attaching the Ether to be escrowed and specifying the intended recipient and a maximum duration for the channel to exist. This is the function <code class="docutils literal notranslate"><span class="pre">SimplePaymentChannel</span></code> in the contract, at the end of this section.</p>
</div>
<div class="section" id="making-payments">
<h4>Making Payments<a class="headerlink" href="#making-payments" title="Permalink to this headline">¶</a></h4>
<p>Alice makes payments by sending signed messages to Bob.
This step is performed entirely outside of the Ethereum network.
Messages are cryptographically signed by the sender and then transmitted directly to the recipient.</p>
<p>Each message includes the following information:</p>
<blockquote>
<div><ul class="simple">
<li>The smart contract’s address, used to prevent cross-contract replay attacks.</li>
<li>The total amount of Ether that is owed the recipient so far.</li>
</ul>
</div></blockquote>
<p>A payment channel is closed just once, at the end of a series of transfers.
Because of this, only one of the messages sent is redeemed. This is why
each message specifies a cumulative total amount of Ether owed, rather than the
amount of the individual micropayment. The recipient will naturally choose to
redeem the most recent message because that is the one with the highest total.
The nonce per-message is not needed anymore, because the smart contract only honors a single message. The address of the smart contract is still used
to prevent a message intended for one payment channel from being used for a different channel.</p>
<p>Here is the modified JavaScript code to cryptographically sign a message from the previous section:</p>
<div class="highlight-Solidity notranslate"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="n">constructPaymentMessage</span><span class="p">(</span><span class="n">contractAddress</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">abi</span><span class="p">.</span><span class="n">soliditySHA3</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&quot;address&quot;</span><span class="p">,</span> <span class="s">&quot;uint256&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="n">contractAddress</span><span class="p">,</span> <span class="n">amount</span><span class="p">]</span>
    <span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="n">signMessage</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">web3</span><span class="p">.</span><span class="n">eth</span><span class="p">.</span><span class="n">personal</span><span class="p">.</span><span class="n">sign</span><span class="p">(</span>
        <span class="s">&quot;0x&quot;</span> <span class="o">+</span> <span class="n">message</span><span class="p">.</span><span class="n">toString</span><span class="p">(</span><span class="s">&quot;hex&quot;</span><span class="p">),</span>
        <span class="n">web3</span><span class="p">.</span><span class="n">eth</span><span class="p">.</span><span class="n">defaultAccount</span><span class="p">,</span>
        <span class="n">callback</span>
    <span class="p">);</span>
<span class="p">}</span>

<span class="c1">// contractAddress is used to prevent cross-contract replay attacks.</span>
<span class="c1">// amount, in wei, specifies how much Ether should be sent.</span>

<span class="kd">function</span> <span class="n">signPayment</span><span class="p">(</span><span class="n">contractAddress</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="n">message</span> <span class="o">=</span> <span class="n">constructPaymentMessage</span><span class="p">(</span><span class="n">contractAddress</span><span class="p">,</span> <span class="n">amount</span><span class="p">);</span>
    <span class="n">signMessage</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">callback</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="closing-the-payment-channel">
<h4>Closing the Payment Channel<a class="headerlink" href="#closing-the-payment-channel" title="Permalink to this headline">¶</a></h4>
<p>When Bob is ready to receive their funds, it is time to
close the payment channel by calling a <code class="docutils literal notranslate"><span class="pre">close</span></code> function on the smart contract.
Closing the channel pays the recipient the Ether they are owed and destroys the contract, sending any remaining Ether back to Alice. To close the channel, Bob needs to provide a message signed by Alice.</p>
<p>The smart contract must verify that the message contains a valid signature from the sender.
The process for doing this verification is the same as the process the recipient uses.
The Solidity functions <code class="docutils literal notranslate"><span class="pre">isValidSignature</span></code> and <code class="docutils literal notranslate"><span class="pre">recoverSigner</span></code> work just like their
JavaScript counterparts in the previous section, with the latter function borrowed from the <code class="docutils literal notranslate"><span class="pre">ReceiverPays</span></code> contract.</p>
<p>Only the payment channel recipient can call the <code class="docutils literal notranslate"><span class="pre">close</span></code> function,
who naturally passes the most recent payment message because that message
carries the highest total owed. If the sender were allowed to call this function,
they could provide a message with a lower amount and cheat the recipient out of what they are owed.</p>
<p>The function verifies the signed message matches the given parameters.
If everything checks out, the recipient is sent their portion of the Ether,
and the sender is sent the rest via a <code class="docutils literal notranslate"><span class="pre">selfdestruct</span></code>.
You can see the <code class="docutils literal notranslate"><span class="pre">close</span></code> function in the full contract.</p>
</div>
<div class="section" id="channel-expiration">
<h4>Channel Expiration<a class="headerlink" href="#channel-expiration" title="Permalink to this headline">¶</a></h4>
<p>Bob can close the payment channel at any time, but if they fail to do so,
Alice needs a way to recover their escrowed funds. An <em>expiration</em> time was set
at the time of contract deployment. Once that time is reached, Alice can call
<code class="docutils literal notranslate"><span class="pre">claimTimeout</span></code> to recover their funds. You can see the <code class="docutils literal notranslate"><span class="pre">claimTimeout</span></code> function in the full contract.</p>
<p>After this function is called, Bob can no longer receive any Ether,
so it is important that Bob closes the channel before the expiration is reached.</p>
</div>
<div class="section" id="id3">
<h4>The full contract<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<div class="highlight-Solidity notranslate"><div class="highlight"><pre><span></span><span class="kr">pragma solidity</span> <span class="o">&gt;=</span><span class="mf">0.4</span><span class="p">.</span><span class="mi">24</span> <span class="o">&lt;</span><span class="mf">0.7</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="kd">contract</span> <span class="n">SimplePaymentChannel</span> <span class="p">{</span>
    <span class="kt">address</span> <span class="kr">payable</span> <span class="kr">public</span> <span class="n">sender</span><span class="p">;</span>      <span class="c1">// The account sending payments.</span>
    <span class="kt">address</span> <span class="kr">payable</span> <span class="kr">public</span> <span class="n">recipient</span><span class="p">;</span>   <span class="c1">// The account receiving the payments.</span>
    <span class="kt">uint256</span> <span class="kr">public</span> <span class="n">expiration</span><span class="p">;</span>  <span class="c1">// Timeout in case the recipient never closes.</span>

    <span class="kd">constructor</span> <span class="p">(</span><span class="kt">address</span> <span class="kr">payable</span> <span class="n">_recipient</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">duration</span><span class="p">)</span>
        <span class="kr">public</span>
        <span class="kr">payable</span>
    <span class="p">{</span>
        <span class="n">sender</span> <span class="o">=</span> <span class="nb">msg.sender</span><span class="p">;</span>
        <span class="n">recipient</span> <span class="o">=</span> <span class="n">_recipient</span><span class="p">;</span>
        <span class="n">expiration</span> <span class="o">=</span> <span class="nb">now</span> <span class="o">+</span> <span class="n">duration</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="n">isValidSignature</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">amount</span><span class="p">,</span> <span class="kt">bytes</span> <span class="kr">memory</span> <span class="n">signature</span><span class="p">)</span>
        <span class="kr">internal</span>
        <span class="kr">view</span>
        <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">bytes32</span> <span class="n">message</span> <span class="o">=</span> <span class="n">prefixed</span><span class="p">(</span><span class="nf">keccak256</span><span class="p">(</span><span class="nb">abi.encodePacked</span><span class="p">(</span><span class="nb">this</span><span class="p">,</span> <span class="n">amount</span><span class="p">)));</span>

        <span class="c1">// check that the signature is from the payment sender</span>
        <span class="k">return</span> <span class="n">recoverSigner</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">signature</span><span class="p">)</span> <span class="o">==</span> <span class="n">sender</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">/// the recipient can close the channel at any time by presenting a</span>
    <span class="c1">/// signed amount from the sender. the recipient will be sent that amount,</span>
    <span class="c1">/// and the remainder will go back to the sender</span>
    <span class="kd">function</span> <span class="n">close</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">amount</span><span class="p">,</span> <span class="kt">bytes</span> <span class="kr">memory</span> <span class="n">signature</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nf">require</span><span class="p">(</span><span class="nb">msg.sender</span> <span class="o">==</span> <span class="n">recipient</span><span class="p">);</span>
        <span class="nf">require</span><span class="p">(</span><span class="n">isValidSignature</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="n">signature</span><span class="p">));</span>

        <span class="n">recipient</span><span class="p">.</span><span class="nf">transfer</span><span class="p">(</span><span class="n">amount</span><span class="p">);</span>
        <span class="nb">selfdestruct</span><span class="p">(</span><span class="n">sender</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">/// the sender can extend the expiration at any time</span>
    <span class="kd">function</span> <span class="n">extend</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">newExpiration</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nf">require</span><span class="p">(</span><span class="nb">msg.sender</span> <span class="o">==</span> <span class="n">sender</span><span class="p">);</span>
        <span class="nf">require</span><span class="p">(</span><span class="n">newExpiration</span> <span class="o">&gt;</span> <span class="n">expiration</span><span class="p">);</span>

        <span class="n">expiration</span> <span class="o">=</span> <span class="n">newExpiration</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">/// if the timeout is reached without the recipient closing the channel,</span>
    <span class="c1">/// then the Ether is released back to the sender.</span>
    <span class="kd">function</span> <span class="n">claimTimeout</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nf">require</span><span class="p">(</span><span class="nb">now</span> <span class="o">&gt;=</span> <span class="n">expiration</span><span class="p">);</span>
        <span class="nb">selfdestruct</span><span class="p">(</span><span class="n">sender</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">/// All functions below this are just taken from the chapter</span>
    <span class="c1">/// &#39;creating and verifying signatures&#39; chapter.</span>

    <span class="kd">function</span> <span class="n">splitSignature</span><span class="p">(</span><span class="kt">bytes</span> <span class="kr">memory</span> <span class="n">sig</span><span class="p">)</span>
        <span class="kr">internal</span>
        <span class="kr">pure</span>
        <span class="k">returns</span> <span class="p">(</span><span class="kt">uint8</span> <span class="n">v</span><span class="p">,</span> <span class="kt">bytes32</span> <span class="n">r</span><span class="p">,</span> <span class="kt">bytes32</span> <span class="n">s</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nf">require</span><span class="p">(</span><span class="n">sig</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">65</span><span class="p">);</span>

        <span class="k">assembly</span> <span class="p">{</span>
            <span class="c1">// first 32 bytes, after the length prefix</span>
            <span class="n">r</span> <span class="o">:=</span> <span class="nf">mload</span><span class="p">(</span><span class="nf">add</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="mi">32</span><span class="p">))</span>
            <span class="c1">// second 32 bytes</span>
            <span class="n">s</span> <span class="o">:=</span> <span class="nf">mload</span><span class="p">(</span><span class="nf">add</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="mi">64</span><span class="p">))</span>
            <span class="c1">// final byte (first byte of the next 32 bytes)</span>
            <span class="n">v</span> <span class="o">:=</span> <span class="nf">byte</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nf">mload</span><span class="p">(</span><span class="nf">add</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="mi">96</span><span class="p">)))</span>
        <span class="p">}</span>

        <span class="nf">return</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span><span class="err">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="n">recoverSigner</span><span class="p">(</span><span class="kt">bytes32</span> <span class="n">message</span><span class="p">,</span> <span class="kt">bytes</span> <span class="kr">memory</span> <span class="n">sig</span><span class="p">)</span>
        <span class="kr">internal</span>
        <span class="kr">pure</span>
        <span class="k">returns</span> <span class="p">(</span><span class="kt">address</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="p">(</span><span class="kt">uint8</span> <span class="n">v</span><span class="p">,</span> <span class="kt">bytes32</span> <span class="n">r</span><span class="p">,</span> <span class="kt">bytes32</span> <span class="n">s</span><span class="p">)</span> <span class="o">=</span> <span class="n">splitSignature</span><span class="p">(</span><span class="n">sig</span><span class="p">);</span>

        <span class="k">return</span> <span class="nf">ecrecover</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">/// builds a prefixed hash to mimic the behavior of eth_sign.</span>
    <span class="kd">function</span> <span class="n">prefixed</span><span class="p">(</span><span class="kt">bytes32</span> <span class="n">hash</span><span class="p">)</span> <span class="kr">internal</span> <span class="kr">pure</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bytes32</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">keccak256</span><span class="p">(</span><span class="nb">abi.encodePacked</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\x19</span><span class="s">Ethereum Signed Message:</span><span class="se">\n</span><span class="s">32&quot;</span><span class="p">,</span> <span class="n">hash</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The function <code class="docutils literal notranslate"><span class="pre">splitSignature</span></code> does not use all security
checks. A real implementation should use a more rigorously tested library,
such as openzepplin’s <a class="reference external" href="https://github.com/OpenZeppelin/openzeppelin-solidity/blob/master/contracts/ECRecovery.sol">version</a> of this code.</p>
</div>
</div>
<div class="section" id="verifying-payments">
<h4>Verifying Payments<a class="headerlink" href="#verifying-payments" title="Permalink to this headline">¶</a></h4>
<p>Unlike in the previous section, messages in a payment channel aren’t
redeemed right away. The recipient keeps track of the latest message and
redeems it when it’s time to close the payment channel. This means it’s
critical that the recipient perform their own verification of each message.
Otherwise there is no guarantee that the recipient will be able to get paid
in the end.</p>
<p>The recipient should verify each message using the following process:</p>
<blockquote>
<div><ol class="arabic simple">
<li>Verify that the contact address in the message matches the payment channel.</li>
<li>Verify that the new total is the expected amount.</li>
<li>Verify that the new total does not exceed the amount of Ether escrowed.</li>
<li>Verify that the signature is valid and comes from the payment channel sender.</li>
</ol>
</div></blockquote>
<p>We’ll use the <a class="reference external" href="https://github.com/ethereumjs/ethereumjs-util">ethereumjs-util</a>
library to write this verification. The final step can be done a number of ways,
and we use JavaScript. The following code borrows the <cite>constructMessage</cite> function from the signing <strong>JavaScript code</strong> above:</p>
<div class="highlight-Solidity notranslate"><div class="highlight"><pre><span></span><span class="c1">// this mimics the prefixing behavior of the eth_sign JSON-RPC method.</span>
<span class="kd">function</span> <span class="n">prefixed</span><span class="p">(</span><span class="n">hash</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">ethereumjs</span><span class="p">.</span><span class="n">ABI</span><span class="p">.</span><span class="n">soliditySHA3</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&quot;string&quot;</span><span class="p">,</span> <span class="s">&quot;bytes32&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&quot;</span><span class="se">\x19</span><span class="s">Ethereum Signed Message:</span><span class="se">\n</span><span class="s">32&quot;</span><span class="p">,</span> <span class="n">hash</span><span class="p">]</span>
    <span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="n">recoverSigner</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">signature</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="n">split</span> <span class="o">=</span> <span class="n">ethereumjs</span><span class="p">.</span><span class="n">Util</span><span class="p">.</span><span class="n">fromRpcSig</span><span class="p">(</span><span class="n">signature</span><span class="p">);</span>
    <span class="kd">var</span> <span class="n">publicKey</span> <span class="o">=</span> <span class="n">ethereumjs</span><span class="p">.</span><span class="n">Util</span><span class="p">.</span><span class="nf">ecrecover</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">split</span><span class="p">.</span><span class="n">v</span><span class="p">,</span> <span class="n">split</span><span class="p">.</span><span class="n">r</span><span class="p">,</span> <span class="n">split</span><span class="p">.</span><span class="n">s</span><span class="p">);</span>
    <span class="kd">var</span> <span class="n">signer</span> <span class="o">=</span> <span class="n">ethereumjs</span><span class="p">.</span><span class="n">Util</span><span class="p">.</span><span class="n">pubToAddress</span><span class="p">(</span><span class="n">publicKey</span><span class="p">).</span><span class="n">toString</span><span class="p">(</span><span class="s">&quot;hex&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">signer</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="n">isValidSignature</span><span class="p">(</span><span class="n">contractAddress</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">signature</span><span class="p">,</span> <span class="n">expectedSigner</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="n">message</span> <span class="o">=</span> <span class="n">prefixed</span><span class="p">(</span><span class="n">constructPaymentMessage</span><span class="p">(</span><span class="n">contractAddress</span><span class="p">,</span> <span class="n">amount</span><span class="p">));</span>
    <span class="kd">var</span> <span class="n">signer</span> <span class="o">=</span> <span class="n">recoverSigner</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">signature</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">signer</span><span class="p">.</span><span class="n">toLowerCase</span><span class="p">()</span> <span class="o">==</span>
        <span class="n">ethereumjs</span><span class="p">.</span><span class="n">Util</span><span class="p">.</span><span class="n">stripHexPrefix</span><span class="p">(</span><span class="n">expectedSigner</span><span class="p">).</span><span class="n">toLowerCase</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="modular-contracts">
<span id="index-3"></span><h2>Modular Contracts<a class="headerlink" href="#modular-contracts" title="Permalink to this headline">¶</a></h2>
<p>A modular approach to building your contracts helps you prevent overflow risks
and unexpected tokens. In the example below, the contract uses the <code class="docutils literal notranslate"><span class="pre">move</span></code> method
of the <code class="docutils literal notranslate"><span class="pre">Balances</span></code> <a class="reference internal" href="contracts.html#libraries"><span class="std std-ref">library</span></a> to check that balances sent between
addresses match what you expect.</p>
<div class="highlight-Solidity notranslate"><div class="highlight"><pre><span></span><span class="kr">pragma solidity</span> <span class="o">&gt;=</span><span class="mf">0.4</span><span class="p">.</span><span class="mi">22</span> <span class="o">&lt;</span><span class="mf">0.7</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="kd">library</span> <span class="n">Balances</span> <span class="p">{</span>
    <span class="kd">function</span> <span class="n">move</span><span class="p">(</span><span class="kd">mapping</span><span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">uint256</span><span class="p">)</span> <span class="kr">storage</span> <span class="n">balances</span><span class="p">,</span> <span class="kt">address</span> <span class="kr">from</span><span class="p">,</span> <span class="kt">address</span> <span class="n">to</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">amount</span><span class="p">)</span> <span class="kr">internal</span> <span class="p">{</span>
        <span class="nf">require</span><span class="p">(</span><span class="n">balances</span><span class="p">[</span><span class="kr">from</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">amount</span><span class="p">);</span>
        <span class="nf">require</span><span class="p">(</span><span class="n">balances</span><span class="p">[</span><span class="n">to</span><span class="p">]</span> <span class="o">+</span> <span class="n">amount</span> <span class="o">&gt;=</span> <span class="n">balances</span><span class="p">[</span><span class="n">to</span><span class="p">]);</span>
        <span class="n">balances</span><span class="p">[</span><span class="kr">from</span><span class="p">]</span> <span class="o">-=</span> <span class="n">amount</span><span class="p">;</span>
        <span class="n">balances</span><span class="p">[</span><span class="n">to</span><span class="p">]</span> <span class="o">+=</span> <span class="n">amount</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">contract</span> <span class="n">Token</span> <span class="p">{</span>
    <span class="kd">mapping</span><span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">uint256</span><span class="p">)</span> <span class="n">balances</span><span class="p">;</span>
    <span class="kn">using</span> <span class="n">Balances</span> <span class="k">for</span> <span class="o">*</span><span class="p">;</span>
    <span class="kd">mapping</span><span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kd">mapping</span> <span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">uint256</span><span class="p">))</span> <span class="n">allowed</span><span class="p">;</span>

    <span class="kd">event</span> <span class="n">Transfer</span><span class="p">(</span><span class="kt">address</span> <span class="kr">from</span><span class="p">,</span> <span class="kt">address</span> <span class="n">to</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">amount</span><span class="p">);</span>
    <span class="kd">event</span> <span class="n">Approval</span><span class="p">(</span><span class="kt">address</span> <span class="n">owner</span><span class="p">,</span> <span class="kt">address</span> <span class="n">spender</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">amount</span><span class="p">);</span>

    <span class="kd">function</span> <span class="n">balanceOf</span><span class="p">(</span><span class="kt">address</span> <span class="n">tokenOwner</span><span class="p">)</span> <span class="kr">public</span> <span class="kr">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint</span> <span class="nb">balance</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">balances</span><span class="p">[</span><span class="n">tokenOwner</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nf">transfer</span><span class="p">(</span><span class="kt">address</span> <span class="n">to</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">amount</span><span class="p">)</span> <span class="kr">public</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span> <span class="n">success</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">balances</span><span class="p">.</span><span class="n">move</span><span class="p">(</span><span class="nb">msg.sender</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">amount</span><span class="p">);</span>
        <span class="kr">emit</span> <span class="n">Transfer</span><span class="p">(</span><span class="nb">msg.sender</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">amount</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>

    <span class="p">}</span>

    <span class="kd">function</span> <span class="n">transferFrom</span><span class="p">(</span><span class="kt">address</span> <span class="kr">from</span><span class="p">,</span> <span class="kt">address</span> <span class="n">to</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">amount</span><span class="p">)</span> <span class="kr">public</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span> <span class="n">success</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">require</span><span class="p">(</span><span class="n">allowed</span><span class="p">[</span><span class="kr">from</span><span class="p">][</span><span class="nb">msg.sender</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">amount</span><span class="p">);</span>
        <span class="n">allowed</span><span class="p">[</span><span class="kr">from</span><span class="p">][</span><span class="nb">msg.sender</span><span class="p">]</span> <span class="o">-=</span> <span class="n">amount</span><span class="p">;</span>
        <span class="n">balances</span><span class="p">.</span><span class="n">move</span><span class="p">(</span><span class="kr">from</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">amount</span><span class="p">);</span>
        <span class="kr">emit</span> <span class="n">Transfer</span><span class="p">(</span><span class="kr">from</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">amount</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="n">approve</span><span class="p">(</span><span class="kt">address</span> <span class="n">spender</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">tokens</span><span class="p">)</span> <span class="kr">public</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span> <span class="n">success</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">require</span><span class="p">(</span><span class="n">allowed</span><span class="p">[</span><span class="nb">msg.sender</span><span class="p">][</span><span class="n">spender</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
        <span class="n">allowed</span><span class="p">[</span><span class="nb">msg.sender</span><span class="p">][</span><span class="n">spender</span><span class="p">]</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">;</span>
        <span class="kr">emit</span> <span class="n">Approval</span><span class="p">(</span><span class="nb">msg.sender</span><span class="p">,</span> <span class="n">spender</span><span class="p">,</span> <span class="n">tokens</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="solidity-in-depth.html" class="btn btn-neutral float-right" title="Solidity in Depth" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="installing-solidity.html" class="btn btn-neutral float-left" title="Installing the Solidity Compiler" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016-2019, Ethereum
      
        <span class="commit">
          Revision <code>23d335f2</code>.
        </span>
      

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org/">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Read the Docs</span>
      v: v0.5.8
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      <dl>
        <dt>Versions</dt>
        
          <dd><a href="https://solidity.readthedocs.io/en/latest/">latest</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/stable/">stable</a></dd>
        
          <dd><a href="index.html">v0.5.8</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.5.7/">v0.5.7</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.5.6/">v0.5.6</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.5.5/">v0.5.5</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.5.4/">v0.5.4</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.5.3/">v0.5.3</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.5.2/">v0.5.2</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.5.1/">v0.5.1</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.5.0/">v0.5.0</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.4.25/">v0.4.25</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.4.24/">v0.4.24</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.4.23/">v0.4.23</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.4.22/">v0.4.22</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.4.21/">v0.4.21</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.4.20/">v0.4.20</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.4.19/">v0.4.19</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.4.18/">v0.4.18</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.4.17/">v0.4.17</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.4.16/">v0.4.16</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.4.15/">v0.4.15</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.4.14/">v0.4.14</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.4.13/">v0.4.13</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.4.12/">v0.4.12</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.4.11/">v0.4.11</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.4.10/">v0.4.10</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.4.9/">v0.4.9</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.4.8/">v0.4.8</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.4.7/">v0.4.7</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.4.6/">v0.4.6</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.4.5/">v0.4.5</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.4.4/">v0.4.4</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.4.3/">v0.4.3</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.4.2/">v0.4.2</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.4.1/">v0.4.1</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.4.0/">v0.4.0</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.3.6/">v0.3.6</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.3.5/">v0.3.5</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.3.4/">v0.3.4</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.3.3/">v0.3.3</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.3.2/">v0.3.2</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.3.1/">v0.3.1</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.3.0/">v0.3.0</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.2.2/">v0.2.2</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.2.1/">v0.2.1</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.2.0/">v0.2.0</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.1.7/">v0.1.7</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.1.6/">v0.1.6</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.1.5/">v0.1.5</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.1.4/">v0.1.4</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.1.3/">v0.1.3</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/v0.1.2/">v0.1.2</a></dd>
        
          <dd><a href="https://solidity.readthedocs.io/en/develop/">develop</a></dd>
        
      </dl>
      <dl>
        <dt>Downloads</dt>
        
      </dl>
      <dl>
        <dt>On Read the Docs</dt>
          <dd>
            <a href="http://readthedocs.org/projects/solidity/?fromdocs=solidity">Project Home</a>
          </dd>
          <dd>
            <a href="http://readthedocs.org/builds/solidity/?fromdocs=solidity">Builds</a>
          </dd>
      </dl>
      <hr/>
      Free document hosting provided by <a href="http://www.readthedocs.org/">Read the Docs</a>.

    </div>
  </div>



  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
   

</body>

<!-- Mirrored from solidity.readthedocs.io/en/v0.5.8/solidity-by-example.html by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 01 May 2019 10:26:58 GMT -->
</html>